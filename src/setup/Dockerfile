FROM debian:stretch-slim

ARG PGBOUNCER_VERSION=""
ARG PGBOUNCER_DOWNLOAD_LINK="https://www.pgbouncer.org/downloads/files/${PGBOUNCER_VERSION}/pgbouncer-${PGBOUNCER_VERSION}.tar.gz"

MAINTAINER Mutlu Polatcan <mutlupolatcan@gmail.com>

ENV PGBOUNCER_CONF_DIR="/pgbouncer_conf" \
	PGBOUNCER_LOGFILE="NULL" \
	PGBOUNCER_PIDFILE="NULL" \
	PGBOUNCER_LISTEN_ADDR="*" \
	PGBOUNCER_LISTEN_PORT="6432" \
	PGBOUNCER_UNIX_SOCKET_DIR="/tmp" \
	PGBOUNCER_UNIX_SOCKET_MODE="0777" \
	PGBOUNCER_UNIX_SOCKET_GROUP="NULL" \
	PGBOUNCER_USER="NULL" \
	PGBOUNCER_AUTH_FILE="NULL" \
	PGBOUNCER_AUTH_HBA_FILE="NULL" \
	PGBOUNCER_AUTH_TYPE="NULL" \
	PGBOUNCER_AUTH_QUERY="SELECT username, passwd FROM pg_shadow WHERE username=$1" \
	PGBOUNCER_AUTH_USER="NULL" \
	PGBOUNCER_POOL_MODE="session" \
	PGBOUNCER_MAX_CLIENT_CONN="100" \
	PGBOUNCER_DEFAULT_POOL_SIZE="20" \
	PGBOUNCER_MIN_POOL_SIZE="0" \
	PGBOUNCER_RESERVE_POOL_SIZE="0" \
	PGBOUNCER_RESERVE_POOL_TIMEOUT="5.0" \
	PGBOUNCER_MAX_DB_CONNECTIONS="NULL" \
	PGBOUNCER_MAX_USER_CONNECTIONS="NULL" \
	PGBOUNCER_SERVER_ROUND_ROBIN="0" \
	PGBOUNCER_IGNORE_STARTUP_PARAMETERS="NULL" \
	PGBOUNCER_DISABLE_PQEXEC="0" \
	PGBOUNCER_APPLICATION_NAME_ADD_HOST="0" \
	PGBOUNCER_SERVICE_NAME="NULL" \
	PGBOUNCER_JOB_NAME="NULL" \
	PGBOUNCER_STATS_PERIOD="60" \
	PGBOUNCER_SYSLOG="0" \
	PGBOUNCER_SYSLOG_IDENT="pgbouncer" \
	PGBOUNCER_SYSLOG_FACILITY="daemon" \
	PGBOUNCER_LOG_CONNECTIONS="1" \
	PGBOUNCER_LOG_DISCONNECTIONS="1" \
	PGBOUNCER_LOG_POOLER_ERRORS="1" \
	PGBOUNCER_LOG_STATS="1" \
	PGBOUNCER_VERBOSE="0" \
	PGBOUNCER_ADMIN_USERS="NULL" \
	PGBOUNCER_STATS_USERS="NULL" \
	PGBOUNCER_SERVER_RESET_QUERY="DISCARD ALL" \
	PGBOUNCER_SERVER_RESET_QUERY_ALWAYS="0" \
	PGBOUNCER_SERVER_CHECK_DELAY="30.0" \
	PGBOUNCER_SERVER_CHECK_QUERY="SELECT 1;" \
	PGBOUNCER_SERVER_FAST_CLOSE="0" \
	PGBOUNCER_SERVER_LIFETIME="3600.0" \
	PGBOUNCER_SERVER_IDLE_TIMEOUT="600.0" \
	PGBOUNCER_SERVER_CONNECT_TIMEOUT="15.0" \
	PGBOUNCER_SERVER_LOGIN_RETRY="15.0" \
	PGBOUNCER_CLIENT_LOGIN_TIMEOUT="60.0" \
	PGBOUNCER_AUTODB_IDLE_TIMEOUT="3600.0" \
	PGBOUNCER_DNS_MAX_TTL="15.0" \
	PGBOUNCER_DNS_NXDOMAIN_TTL="15.0" \
	PGBOUNCER_DNS_ZONE_CHECK_PERIOD="0.0" \
	PGBOUNCER_RESOLV_CONF="NULL" \
	PGBOUNCER_CLIENT_TLS_SSLMODE="disable" \
	PGBOUNCER_CLIENT_TLS_KEY_FILE="NULL" \
	PGBOUNCER_CLIENT_TLS_CERT_FILE="NULL" \
	PGBOUNCER_CLIENT_TLS_CA_FILE="NULL" \
	PGBOUNCER_CLIENT_TLS_PROTOCOLS="all" \
	PGBOUNCER_CLIENT_TLS_CIPHERS="fast" \
	PGBOUNCER_CLIENT_TLS_ECDHCURVE="auto" \
	PGBOUNCER_CLIENT_TLS_DHEPARAMS="auto" \
	PGBOUNCER_SERVER_TLS_SSLMODE="disable" \
	PGBOUNCER_SERVER_TLS_CA_FILE="NULL" \
	PGBOUNCER_SERVER_TLS_KEY_FILE="NULL" \
	PGBOUNCER_SERVER_TLS_CERT_FILE="NULL" \
	PGBOUNCER_SERVER_TLS_PROTOCOLS="all" \
	PGBOUNCER_SERVER_TLS_CIPHERS="fast" \
	PGBOUNCER_QUERY_TIMEOUT="0.0" \
	PGBOUNCER_QUERY_WAIT_TIMEOUT="120" \
	PGBOUNCER_CLIENT_IDLE_TIMEOUT="0.0" \
	PGBOUNCER_IDLE_TRANSACTION_TIMEOUT="0.0" \
	PGBOUNCER_SUSPEND_TIMEOUT="10" \
	PGBOUNCER_PKT_BUF="4096" \
	PGBOUNCER_MAX_PACKET_SIZE="2147483647" \
	PGBOUNCER_LISTEN_BACKLOG="128" \
	PGBOUNCER_SBUF_LOOPCNT="5" \
	PGBOUNCER_SO_REUSEPORT="0" \
	PGBOUNCER_TCP_DEFER_ACCEPT="45" \
	PGBOUNCER_TCP_SOCKET_BUFFER="NULL" \
	PGBOUNCER_TCP_KEEPALIVE="1" \
	PGBOUNCER_TCP_KEEPCNT="NULL" \
	PGBOUNCER_TCP_KEEPIDLE="NULL" \
	PGBOUNCER_TCP_KEEPINTVL="NULL" \
	DATABASES_DBNAME="NULL" \
	DATABASES_HOST="NULL" \
	DATABASES_PORT="5432" \
	DATABASES_USER="NULL" \
	DATABASES_PASSWORD="NULL" \
	DATABASES_AUTH_USER="NULL" \
	DATABASES_POOL_SIZE="NULL" \
	DATABASES_RESERVE_POOL="NULL" \
	DATABASES_CONNECT_QUERY="NULL" \
	DATABASES_POOL_MODE="NULL" \
	DATABASES_MAX_DB_CONNECTIONS="NULL" \
	DATABASES_CLIENT_ENCODING="NULL" \
	DATABASES_DATESTYLE="NULL" \
	DATABASES_TIMEZONE="NULL" \
	USERS_POOL_MODE="NULL" \
	USERS_MAX_USER_CONNECTIONS="NULL"

ADD config_loader.sh ./pgbouncer_config_loader.sh
ADD entrypoint.sh ./pgbouncer_entrypoint.sh

RUN apt-get update && \
    apt-get -y install wget \
                       build-essential \
                       pkg-config \
                       libevent-dev \
                       libssl-dev && \
    rm -rf /var/lib/apt/lists/* && \
    wget ${PGBOUNCER_DOWNLOAD_LINK} && \
    tar xvzf pgbouncer-${PGBOUNCER_VERSION}.tar.gz && \
    pgbouncer-${PGBOUNCER_VERSION}/configure --prefix=/usr/local && \
    make -f pgbouncer-${PGBOUNCER_VERSION}/Makefile && \
    make -f pgbouncer-${PGBOUNCER_VERSION}/Makefile install && \
    rm -r pgbouncer-${PGBOUNCER_VERSION}.* && \
    mkdir -p ${PGBOUNCER_CONF_DIR}

ENTRYPOINT ["./pgbouncer_entrypoint.sh"]
